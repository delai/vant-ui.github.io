import{c as te,u as re,f as ne,l as oe,E as U,e as me,b as fe,F as de}from"./use-translate.813c82b8.js";import{d as K,u as he,a as ve,n as G,b as ae,c as $,m as ge,t as xe}from"./with-install.ed706383.js";import{H as Q,a as be}from"./constant.80c6de18.js";import{u as le}from"./use-expose.f2ccb00a.js";import{L as Ce}from"./index.04ba88cf.js";import{d as W}from"./deep-clone.7e26cfde.js";import{u as Te}from"./use-touch.1aeb3848.js";import{z as ie,D as q,H as ye,x as F,e as r,C as Y}from"./vue-libs.e99ed056.js";const X=200,Z=300,Ie=15,[se,z]=te("picker-column");function we(t){const{transform:v}=window.getComputedStyle(t),c=v.slice(7,v.length-1).split(", ")[5];return Number(c)}const ce=Symbol(se),J=t=>ne(t)&&t.disabled;var Oe=ie({name:se,props:{textKey:K(String),readonly:Boolean,allowHtml:Boolean,className:he,itemHeight:K(Number),defaultIndex:ve(0),swipeDuration:K(G),initialOptions:ae(),visibleItemCount:K(G)},emits:["change"],setup(t,{emit:v,slots:c}){let f,d,i,g,b;const y=q(),a=ye({index:t.defaultIndex,offset:0,duration:0,options:W(t.initialOptions)}),w=Te(),O=()=>a.options.length,k=()=>t.itemHeight*(+t.visibleItemCount-1)/2,D=o=>{o=U(o,0,O());for(let l=o;l<O();l++)if(!J(a.options[l]))return l;for(let l=o-1;l>=0;l--)if(!J(a.options[l]))return l},m=(o,l)=>{o=D(o)||0;const u=-o*t.itemHeight,h=()=>{o!==a.index&&(a.index=o,l&&v("change",o))};f&&u!==a.offset?b=h:h(),a.offset=u},C=o=>{JSON.stringify(o)!==JSON.stringify(a.options)&&(a.options=W(o),m(t.defaultIndex))},M=o=>{f||t.readonly||(b=null,a.duration=X,m(o,!0))},S=o=>ne(o)&&t.textKey in o?o[t.textKey]:o,H=o=>U(Math.round(-o/t.itemHeight),0,O()-1),N=(o,l)=>{const u=Math.abs(o/l);o=a.offset+u/.003*(o<0?-1:1);const h=H(o);a.duration=+t.swipeDuration,m(h,!0)},B=()=>{f=!1,a.duration=0,b&&(b(),b=null)},P=o=>{if(!t.readonly){if(w.start(o),f){const l=we(y.value);a.offset=Math.min(0,l-k()),d=a.offset}else d=a.offset;a.duration=0,i=Date.now(),g=d,b=null}},A=o=>{if(t.readonly)return;w.move(o),w.isVertical()&&(f=!0,oe(o,!0)),a.offset=U(d+w.deltaY.value,-(O()*t.itemHeight),t.itemHeight);const l=Date.now();l-i>Z&&(i=l,g=a.offset)},V=()=>{if(t.readonly)return;const o=a.offset-g,l=Date.now()-i;if(l<Z&&Math.abs(o)>Ie){N(o,l);return}const h=H(a.offset);a.duration=X,m(h,!0),setTimeout(()=>{f=!1},0)},_=()=>{const o={height:`${t.itemHeight}px`};return a.options.map((l,u)=>{const h=S(l),E=J(l),j={role:"button",style:o,tabindex:E?-1:0,class:z("item",{disabled:E,selected:u===a.index}),onClick:()=>M(u)},R={class:"van-ellipsis",[t.allowHtml?"innerHTML":"textContent"]:h};return r("li",j,[c.option?c.option(l):r("div",R,null)])})},L=o=>{const{options:l}=a;for(let u=0;u<l.length;u++)if(S(l[u])===o)return m(u)},p=()=>a.options[a.index];return m(a.index),re(ce),le({state:a,setIndex:m,getValue:p,setValue:L,setOptions:C,stopMomentum:B}),F(()=>t.initialOptions,C),F(()=>t.defaultIndex,o=>m(o)),()=>r("div",{class:[z(),t.className],onTouchstart:P,onTouchmove:A,onTouchend:V,onTouchcancel:V},[r("ul",{ref:y,style:{transform:`translate3d(0, ${a.offset+k()}px, 0)`,transitionDuration:`${a.duration}ms`,transitionProperty:a.duration?"all":"none"},class:z("wrapper"),onTransitionend:B},[_()])])}});const[ke,x,ee]=te("picker"),He={title:String,loading:Boolean,readonly:Boolean,allowHtml:Boolean,itemHeight:$(44),showToolbar:xe,swipeDuration:$(1e3),visibleItemCount:$(6),cancelButtonText:String,confirmButtonText:String},Me=me({},He,{columns:ae(),valueKey:String,defaultIndex:$(0),toolbarPosition:ge("top"),columnsFieldNames:Object});var pe=ie({name:ke,props:Me,emits:["confirm","cancel","change"],setup(t,{emit:v,slots:c}){const f=q(!1),d=q([]),i=Y(()=>{const{columnsFieldNames:e}=t;return{text:(e==null?void 0:e.text)||t.valueKey||"text",values:(e==null?void 0:e.values)||"values",children:(e==null?void 0:e.children)||"children"}}),{children:g,linkChildren:b}=fe(ce);b();const y=Y(()=>de(t.itemHeight)),a=Y(()=>{const e=t.columns[0];if(typeof e=="object"){if(i.value.children in e)return"cascade";if(i.value.values in e)return"object"}return"plain"}),w=()=>{var s;const e=[];let n={[i.value.children]:t.columns};for(;n&&n[i.value.children];){const T=n[i.value.children];let I=(s=n.defaultIndex)!=null?s:+t.defaultIndex;for(;T[I]&&T[I].disabled;)if(I<T.length-1)I++;else{I=0;break}e.push({[i.value.values]:n[i.value.children],className:n.className,defaultIndex:I}),n=T[I]}d.value=e},O=()=>{const{columns:e}=t;a.value==="plain"?d.value=[{[i.value.values]:e}]:a.value==="cascade"?w():d.value=e,f.value=d.value.some(n=>n[i.value.values]&&n[i.value.values].length!==0)},k=()=>g.map(e=>e.state.index),D=(e,n)=>{const s=g[e];s&&(s.setOptions(n),f.value=!0)},m=e=>{let n={[i.value.children]:t.columns};const s=k();for(let T=0;T<=e;T++)n=n[i.value.children][s[T]];for(;n&&n[i.value.children];)e++,D(e,n[i.value.children]),n=n[i.value.children][n.defaultIndex||0]},C=e=>g[e],M=e=>{const n=C(e);if(n)return n.getValue()},S=(e,n)=>{const s=C(e);s&&(s.setValue(n),a.value==="cascade"&&m(e))},H=e=>{const n=C(e);if(n)return n.state.index},N=(e,n)=>{const s=C(e);s&&(s.setIndex(n),a.value==="cascade"&&m(e))},B=e=>{const n=C(e);if(n)return n.state.options},P=()=>g.map(e=>e.getValue()),A=e=>{e.forEach((n,s)=>{S(s,n)})},V=e=>{e.forEach((n,s)=>{N(s,n)})},_=e=>{a.value==="plain"?v(e,M(0),H(0)):v(e,P(),k())},L=e=>{a.value==="cascade"&&m(e),a.value==="plain"?v("change",M(0),H(0)):v("change",P(),e)},p=()=>{g.forEach(e=>e.stopMomentum()),_("confirm")},o=()=>_("cancel"),l=()=>{if(c.title)return c.title();if(t.title)return r("div",{class:[x("title"),"van-ellipsis"]},[t.title])},u=()=>{const e=t.cancelButtonText||ee("cancel");return r("button",{type:"button",class:[x("cancel"),Q],onClick:o},[c.cancel?c.cancel():e])},h=()=>{const e=t.confirmButtonText||ee("confirm");return r("button",{type:"button",class:[x("confirm"),Q],onClick:p},[c.confirm?c.confirm():e])},E=()=>{if(t.showToolbar){const e=c.toolbar||c.default;return r("div",{class:x("toolbar")},[e?e():[u(),l(),h()]])}},j=()=>d.value.map((e,n)=>{var s;return r(Oe,{textKey:i.value.text,readonly:t.readonly,allowHtml:t.allowHtml,className:e.className,itemHeight:y.value,defaultIndex:(s=e.defaultIndex)!=null?s:+t.defaultIndex,swipeDuration:t.swipeDuration,initialOptions:e[i.value.values],visibleItemCount:t.visibleItemCount,onChange:()=>L(n)},{option:c.option})}),R=e=>{if(f.value){const n={height:`${y.value}px`},s={backgroundSize:`100% ${(e-y.value)/2}px`};return[r("div",{class:x("mask"),style:s},null),r("div",{class:[be,x("frame")],style:n},null)]}},ue=()=>{const e=y.value*+t.visibleItemCount,n={height:`${e}px`};return r("div",{class:x("columns"),style:n,onTouchmove:oe},[j(),R(e)])};return F(()=>t.columns,O,{immediate:!0}),le({confirm:p,getValues:P,setValues:A,getIndexes:k,setIndexes:V,getColumnIndex:H,setColumnIndex:N,getColumnValue:M,setColumnValue:S,getColumnValues:B,setColumnValues:D}),()=>{var e,n;return r("div",{class:x()},[t.toolbarPosition==="top"?E():null,t.loading?r(Ce,{class:x("loading")},null):null,(e=c["columns-top"])==null?void 0:e.call(c),ue(),(n=c["columns-bottom"])==null?void 0:n.call(c),t.toolbarPosition==="bottom"?E():null])}}});export{pe as _,He as p};
